---
- name: read created file to configure secret key as one-time password and save emergency scratch codes
  ansible.builtin.command:
    argv:
      - cat
      - /home/{{ item.name }}/.google_authenticator
  loop: "{{ users }}"
  register: two_fa_codes
  changed_when: False

- name: sign in to a 1password account
  shell: |
    export OP_DEVICE="{{ one_password_device_id }}"
    echo "{{ one_password_password }}" | op signin "{{ one_password_sign_in_address }}" "{{ one_password_email_address }}" "{{ one_password_secret_key }}" --raw
  delegate_to: localhost
  become: no
  register: op_session_token
  changed_when: False

- name: check that vault created
  shell: |
    export OP_SESSION_my="{{ op_session_token.stdout }}"
    op get vault "{{ one_password_vault_name }}"
  delegate_to: localhost
  become: no
  ignore_errors: True
  register: vault_created
  changed_when: False

- name: create vault in 1password
  shell: |
    export OP_SESSION_my="{{ op_session_token.stdout }}"
    op create vault "{{ one_password_vault_name }}"
  delegate_to: localhost
  become: no
  when: vault_created.rc != 0

- name: check that item(-s) created
  shell: |
    export OP_SESSION_my="{{ op_session_token.stdout }}"
    op get item "{{ item.name }}" --vault "{{ one_password_vault_name }}"
  loop: "{{ servers }}"
  delegate_to: localhost
  become: no
  ignore_errors: True
  register: item_created
  run_once: True
  changed_when: False

- name: create a local temporary folder
  ansible.builtin.file:
    path: "/tmp/ansible.{{ lookup('password', '/dev/null chars=ascii_lowercase,digits length=8') }}"
    state: directory
  delegate_to: localhost
  become: no
  register: tempdir
  run_once: True
  when: item_created.results.{{ item }}.rc != 0
  loop: "{{ range(0, ((servers|length)-1) +1) | list }}"

- name: (re-)create item(-s) in vault
  block:
    - name: delete item(-s)
      shell: |
        export OP_SESSION_my="{{ op_session_token.stdout }}"
        op delete item "{{ item.name }}" --vault "{{ one_password_vault_name }}"
      loop: "{{ servers }}"
      ignore_errors: True

    - name: render config to upload to 1password
      ansible.builtin.template:
        src: server.json.j2
        dest: "{{ tempdir['results'] | json_query('[*].path') | first }}/{{ item }}-server.json"
      loop: "{{ groups['hcloud'] }}"

    - name: create an item with a template in vault
      shell: |
        export OP_SESSION_my="{{ op_session_token.stdout }}"
        op create item "Server" --title "{{ item.name }}" "$(op encode < {{ tempdir['results'] | json_query('[*].path') | first }}/{{ item.name }}-server.json )" --vault "{{ one_password_vault_name }}"
        sleep 2
      loop: "{{ servers }}"
  delegate_to: localhost
  become: no
  run_once: True
  when: tempdir.changed

- name: delete a local temporary folder
  ansible.builtin.file:
    path: "{{ tempdir['results'][item]['path'] }}"
    state: absent
  when: "{{ tempdir['results'][item]['path'] is defined }}"
  loop: "{{ range(0, ((servers|length)-1) +1) | list }}"
  delegate_to: localhost
  become: no
  run_once: True
  changed_when: False

- name: sign out from a 1password account (1/2)
  shell: op signout --forget
  delegate_to: localhost
  become: no
  changed_when: False

- name: sign out from a 1password account (2/2)
  ansible.builtin.file:
    path: $HOME/.config/op/config
    state: absent
  delegate_to: localhost
  become: no
  changed_when: False
